<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Two Counties, Two Realities - Mortgage Inequality Explorer</title>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        :root {
            --primary: #2c3e50;
            --accent: #667eea;
            --highlight: #764ba2;
            --sd-color: #ff9f43; /* San Diego Color */
            --target-color: #54a0ff; /* Selected County Color */
            --bg-light: #f8f9fa;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f7fa;
            color: var(--primary);
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Map Section (Selector) */
        .selector-section {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            margin-bottom: 40px;
        }

        .header-title {
            text-align: center;
            font-size: 2.2rem;
            margin-bottom: 10px;
            color: var(--primary);
            font-weight: 700;
        }

        .header-subtitle {
            text-align: center;
            color: #7f8c8d;
            margin-bottom: 30px;
        }

        .controls {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 20px;
            padding: 15px;
            background: var(--bg-light);
            border-radius: 10px;
            align-items: center;
        }

        select {
            padding: 10px 15px;
            border-radius: 8px;
            border: 1px solid #ddd;
            font-size: 16px;
        }

        /* Story Section Structure */
        #story-container {
            display: none; /* Hidden until loaded */
            animation: fadeIn 0.8s ease-out;
        }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        .story-section {
            background: white;
            border-radius: 20px;
            padding: 40px;
            margin-bottom: 30px;
            box-shadow: 0 5px 25px rgba(0,0,0,0.05);
            display: grid;
            grid-template-columns: 1fr 1.2fr;
            gap: 50px;
            align-items: start;
        }

        .story-section.full-width {
            grid-template-columns: 1fr;
        }

        /* Text Slider (The Analysis Feature) */
        .text-slider {
            position: relative;
            min-height: 350px;
        }

        .slide {
            display: none;
            animation: fadeText 0.5s ease-in-out;
        }
        
        .slide.active { display: block; }

        @keyframes fadeText { from { opacity: 0; } to { opacity: 1; } }

        .section-label {
            text-transform: uppercase;
            letter-spacing: 2px;
            font-size: 0.85rem;
            color: var(--accent);
            font-weight: bold;
            margin-bottom: 10px;
            display: block;
        }

        .section-title {
            font-size: 1.8rem;
            margin-bottom: 20px;
            line-height: 1.2;
            color: var(--primary);
        }

        .statement {
            font-size: 1.05rem;
            color: #444;
            margin-bottom: 25px;
            line-height: 1.7;
        }

        .statements {
            font-size: 1.1rem;
            color: #444;
            margin-bottom: 25px;
            border-left: 4px solid var(--accent);
            padding-left: 20px;
        }

        .soft-question {
            background: linear-gradient(to right, #eef2f3, #e8e9eb);
            padding: 20px;
            border-radius: 12px;
            font-style: italic;
            color: var(--primary);
            font-weight: 500;
            border-left: 4px solid var(--accent);
        }

        /* Analysis Box Style */
        .analysis-box {
            background: #f0f7ff;
            border-left: 6px solid var(--target-color);
            padding: 25px;
            border-radius: 12px;
            margin-top: 10px;
        }
        
        .analysis-highlight {
            font-size: 1.2rem;
            font-weight: bold;
            color: var(--highlight);
            margin-bottom: 15px;
            display: block;
        }

        .analysis-text {
            font-size: 1.1rem;
            color: #34495e;
            line-height: 1.8;
        }

        /* Navigation Controls */
        .nav-controls {
            margin-top: 25px;
            display: flex;
            gap: 15px;
            border-top: 1px solid #eee;
            padding-top: 20px;
        }

        .nav-btn {
            background: white;
            border: 2px solid #eee;
            color: #7f8c8d;
            padding: 8px 20px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 700;
            font-size: 0.9rem;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .nav-btn:hover { background: #f8f9fa; border-color: #ddd; }
        .nav-btn.active { 
            background: var(--accent); 
            border-color: var(--accent); 
            color: white; 
            box-shadow: 0 4px 10px rgba(102, 126, 234, 0.3);
        }

        .chart-container {
            background: white;
            border-radius: 15px;
            padding: 10px;
            min-height: 400px;
            position: relative;
        }

        /* Hero Stats */
        .hero-stats {
            display: flex;
            justify-content: center;
            gap: 60px;
            margin: 40px 0;
            text-align: center;
        }

        .stat-box h3 { font-size: 3rem; color: var(--highlight); margin-bottom: 5px; }
        .stat-box p { color: #7f8c8d; font-weight: bold; text-transform: uppercase; letter-spacing: 1px; font-size: 0.9rem; }

        /* Sources */
        .sources-section {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 40px;
            border-radius: 15px;
            margin-top: 50px;
        }
        .sources-section h3 { border-bottom: 1px solid #7f8c8d; padding-bottom: 10px; margin-bottom: 20px; }
        .sources-section p { margin-bottom: 15px; font-size: 0.95rem; opacity: 0.9; }
        .sources-section ul { margin-left: 20px; margin-bottom: 20px; opacity: 0.9; font-size: 0.95rem; }

        /* Loading */
        #loading { text-align: center; padding: 50px; }
        .spinner {
            border: 4px solid #f3f3f3; border-top: 4px solid var(--accent);
            border-radius: 50%; width: 50px; height: 50px;
            animation: spin 1s linear infinite; margin: 0 auto 20px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Utility */
        .highlight-text { color: var(--highlight); font-weight: bold; }
        .county-name-target { font-weight: bold; color: var(--target-color); }
        .btn-toggle {
            background: var(--accent); color: white; border: none; padding: 10px 20px;
            border-radius: 20px; cursor: pointer; font-weight: bold; margin-top: 0;
            transition: transform 0.2s;
        }
        .btn-toggle:hover { transform: scale(1.05); }
        .btn-back { background: #e74c3c; color: white; }
        
        .map-breadcrumb { text-align: center; margin-bottom: 15px; font-weight: bold; color: var(--accent); }

        .custom-legend { display: flex; justify-content: center; gap: 20px; margin-bottom: 15px; }
        .legend-item { display: flex; align-items: center; gap: 8px; font-weight: bold; font-size: 0.9rem; }
        .dot { width: 12px; height: 12px; border-radius: 50%; }
    </style>
</head>
<body>

<div class="container">
    <div class="selector-section">
        <h1 class="header-title">Two Counties, Two Realities.<br>How Mortgage Outcomes Differ from <span class="county-name-target highlight-text"></span> to San Diego, CA?</h1>
        <p class="header-subtitle">Interactive Analysis: Select a State, then a County to compare</p>
        
        <div class="controls">
            <div>
                <label><strong>Year:</strong></label>
                <select id="year-select"></select>
            </div>
            <div>
                <label><strong>State:</strong></label>
                <select id="state-select">
                    <option value="">-- Select a State --</option>
                </select>
            </div>
            <button class="btn-toggle btn-back" id="back-btn" onclick="resetToUSA()" style="display:none;">‚Üê Back to USA</button>
        </div>

        <div id="loading">
            <div class="spinner"></div>
            <p>Loading Data (2018-2023)...</p>
        </div>

        <div class="map-breadcrumb" id="map-status">Viewing: United States</div>
        <div id="map-container" style="height: 500px;"></div>
        <p id="map-instruction" style="text-align: center; color: #7f8c8d; margin-top: 10px;">üëÜ Click on any State to drill down to counties.</p>
    </div>

    <div id="story-container">
        
        <div class="story-section full-width">
            <div style="text-align: center; max-width: 900px; margin: 0 auto;">
                <span class="section-label">Section 0 ‚Äî Intro</span>
                <h2 class="section-title" style="font-size: 2.5rem;">Two Counties, Two Realities.<br>How Mortgage Outcomes Differ from <span class="county-name-target highlight-text"></span> to San Diego, CA?</h2>
                
                <div class="statements">
                        <strong>Is the opportunity for homeownership fairly distributed where you live?</strong><br>
                        Buying a home does not look the same everywhere. Even inside one state, the mortgage experience
                        can change sharply from one county to the next. The people who apply, the homes they pursue, and
                        the income groups that show up in the market all shape how accessible homeownership feels.
                    </div>

                <div class="hero-stats">
                    <div class="stat-box">
                        <h3 id="hero-target-stat">--%</h3>
                        <p>Minority Share<br><span class="county-name-target"></span></p>
                    </div>
                    <div class="stat-box">
                        <h3 id="hero-sd-stat">--%</h3>
                        <p>Minority Share<br>San Diego County</p>
                    </div>
                </div>

                <div class="statement" style="text-align: center; margin-bottom: 0;">
                    Before we compare San Diego County to <span class="county-name-target"></span>, we pause with one guiding question:
                </div>
                <div class="soft-question" style="text-align: center; border-left: none; border-top: 4px solid var(--accent); margin-top: 20px;">
                    Who is entering the mortgage market here, and what early patterns can we already see?
                </div>
            </div>
        </div>

        <div class="story-section" id="section-loan">
            <div class="text-slider">
                <div class="slide slide-1 active">
                    <span class="section-label">Section 1 ‚Äî Loan Amount Distribution</span>
                    <h2 class="section-title">The Price of Entry</h2>
                    <div class="statement">
                        The first view focuses on loan amounts in <span class="county-name-target"></span>. This tells us the price range most buyers operate in. Lower amounts hint at more affordable markets. Higher amounts suggest that even entry level homes sit at a higher price point. These clusters help define the economic landscape local buyers navigate.
                    </div>
                    <div class="soft-question">
                        As you scroll, do the loan patterns in <span class="county-name-target"></span> feel more expensive, more affordable, or more balanced compared to San Diego County?
                    </div>
                </div>
                <div class="slide slide-2">
                    <span class="section-label">Section 1 ‚Äî Analysis</span>
                    <h2 class="section-title">The Story Behind the Numbers</h2>
                    <div class="analysis-box">
                        <span class="analysis-highlight" id="analysis-loan-highlight">Loading Analysis...</span>
                        <p class="analysis-text" id="analysis-loan-text"></p>
                    </div>
                </div>
                <div class="nav-controls">
                    <button class="nav-btn active" onclick="switchSlide('section-loan', 1)">1. Overview</button>
                    <button class="nav-btn" onclick="switchSlide('section-loan', 2)">2. Explore Analysis ‚Üí</button>
                </div>
            </div>
            <div class="chart-container">
                <div class="custom-legend">
                    <div class="legend-item"><div class="dot" style="background:var(--target-color)"></div><span class="county-name-target"></span></div>
                    <div class="legend-item"><div class="dot" style="background:var(--sd-color)"></div>San Diego</div>
                </div>
                <div id="chart-loan"></div>
            </div>
        </div>

        <div class="story-section" id="section-age">
            <div class="text-slider">
                <div class="slide slide-1 active">
                    <span class="section-label">Section 2 ‚Äî Age Distribution</span>
                    <h2 class="section-title">Generational Access</h2>
                    <div class="statement">
                        Now we look at borrower age. Age distribution shows which life stages drive the mortgage market in <span class="county-name-target"></span>. Younger adults might signal starter home activity. Mid-career buyers often shape the core of the market. Older households may point to refinancing or later home transitions.
                    </div>
                    <div class="soft-question">
                        Does the age mix resemble San Diego, or does one county lean toward a different stage of life?
                    </div>
                </div>
                <div class="slide slide-2">
                    <span class="section-label">Section 2 ‚Äî Analysis</span>
                    <h2 class="section-title">The Story Behind the Numbers</h2>
                    <div class="analysis-box">
                        <span class="analysis-highlight" id="analysis-age-highlight">Loading Analysis...</span>
                        <p class="analysis-text" id="analysis-age-text"></p>
                    </div>
                </div>
                <div class="nav-controls">
                    <button class="nav-btn active" onclick="switchSlide('section-age', 1)">1. Overview</button>
                    <button class="nav-btn" onclick="switchSlide('section-age', 2)">2. Explore Analysis ‚Üí</button>
                </div>
            </div>
            <div class="chart-container">
                <div class="custom-legend">
                    <div class="legend-item"><div class="dot" style="background:var(--target-color)"></div><span class="county-name-target"></span></div>
                    <div class="legend-item"><div class="dot" style="background:var(--sd-color)"></div>San Diego</div>
                </div>
                <div id="chart-age"></div>
            </div>
        </div>

        <div class="story-section" id="section-race">
            <div class="text-slider">
                <div class="slide slide-1 active">
                    <span class="section-label">Section 3 ‚Äî Race & Ethnicity</span>
                    <h2 class="section-title">Who Gets the Loan?</h2>
                    <div class="statement">
                        Next, we explore the racial and ethnic composition of borrowers in <span class="county-name-target"></span>. This view helps us understand who participates most in the mortgage process. It also highlights demographic differences that may shape access, opportunity, and the overall borrower landscape.
                    </div>
                    <div class="soft-question">
                        When the proportions shift between <span class="county-name-target"></span> and San Diego, which differences stand out the most?
                    </div>
                </div>
                <div class="slide slide-2">
                    <span class="section-label">Section 3 ‚Äî Analysis</span>
                    <h2 class="section-title">The Story Behind the Numbers</h2>
                    <div class="analysis-box">
                        <span class="analysis-highlight" id="analysis-race-highlight">Loading Analysis...</span>
                        <p class="analysis-text" id="analysis-race-text"></p>
                    </div>
                </div>
                <div class="nav-controls">
                    <button class="nav-btn active" onclick="switchSlide('section-race', 1)">1. Overview</button>
                    <button class="nav-btn" onclick="switchSlide('section-race', 2)">2. Explore Analysis ‚Üí</button>
                </div>
            </div>
            <div class="chart-container">
                <div class="custom-legend">
                    <div class="legend-item"><div class="dot" style="background:var(--target-color)"></div><span class="county-name-target"></span></div>
                    <div class="legend-item"><div class="dot" style="background:var(--sd-color)"></div>San Diego</div>
                </div>
                <div id="chart-race"></div>
            </div>
        </div>

        <div class="story-section" id="section-income">
            <div class="text-slider">
                <div class="slide slide-1 active">
                    <span class="section-label">Section 4 ‚Äî Income Level</span>
                    <h2 class="section-title">Affordability Barriers</h2>
                    <div class="statement">
                        Income levels offer another layer of context. They show which income groups are most active in <span class="county-name-target"></span> and how affordability filters who can pursue a mortgage. Some counties have broad representation across income tiers. Others skew toward a narrow band of households.
                    </div>
                    <div class="soft-question">
                        How does the income landscape in <span class="county-name-target"></span> line up with the income patterns you see in San Diego County?
                    </div>
                </div>
                <div class="slide slide-2">
                    <span class="section-label">Section 4 ‚Äî Analysis</span>
                    <h2 class="section-title">The Story Behind the Numbers</h2>
                    <div class="analysis-box">
                        <span class="analysis-highlight" id="analysis-income-highlight">Loading Analysis...</span>
                        <p class="analysis-text" id="analysis-income-text"></p>
                    </div>
                </div>
                <div class="nav-controls">
                    <button class="nav-btn active" onclick="switchSlide('section-income', 1)">1. Overview</button>
                    <button class="nav-btn" onclick="switchSlide('section-income', 2)">2. Explore Analysis ‚Üí</button>
                </div>
            </div>
            <div class="chart-container">
                <div class="custom-legend">
                    <div class="legend-item"><div class="dot" style="background:var(--target-color)"></div><span class="county-name-target"></span></div>
                    <div class="legend-item"><div class="dot" style="background:var(--sd-color)"></div>San Diego</div>
                </div>
                <div id="chart-income"></div>
            </div>
        </div>

        <div class="story-section">
            <div class="text-content">
                <span class="section-label">Section 5 ‚Äî Race √ó Income Heatmap</span>
                <h2 class="section-title">The Intersection</h2>
                <div class="statement">
                    The race and income heatmap brings the story together. It shows which racial groups are concentrated in which income levels and how these combinations shape real borrowing behavior. This produces a deeper look at patterns that do not show up when race and income are viewed separately.
                </div>
                <div class="soft-question">
                    As this heatmap transitions to San Diego County, which race income combinations shift the most?
                </div>
                <div style="margin-top: 20px; text-align: center;">
                    <p id="heatmap-status" style="margin-bottom: 5px; font-weight: bold;">Currently Viewing: <span class="county-name-target"></span></p>
                    <button class="btn-toggle" onclick="toggleHeatmap()">Swap View ‚áÑ</button>
                </div>
            </div>
            <div class="chart-container">
                <div id="chart-heatmap"></div>
            </div>
        </div>

        <div class="story-section full-width">
            <div style="text-align: center; max-width: 800px; margin: 0 auto;">
                <span class="section-label">Section 6 ‚Äî Closing Takeaway</span>
                <h2 class="section-title">The Full Picture</h2>
                
                <div class="statement">
                    Loan amounts, age distribution, race, ethnicity, and income combine to show that two counties living side by side can have very different mortgage realities. Each chart adds its own clue. Together they reveal how geography can influence access, affordability, and opportunity.
                </div>

                <div class="soft-question" style="text-align: center; border: none; background: #eef2f3; font-weight: bold;">
                    After seeing the full picture, which differences between <span class="county-name-target"></span> and San Diego County feel the most meaningful to you?
                </div>
            </div>
        </div>

        <div class="sources-section">
            <h3>Data Sources</h3>
            <p>All data used in this story comes from public and open datasets.</p>
            <p><strong>HMDA Neighborhood Summary Files (Urban Institute):</strong> Tract-level dataset from 2018 to 2023 summarizing mortgage activity.</p>
            <p><strong>FRED Economic Indicators:</strong> Mortgage Rate Series (MORTGAGE30US) and Unemployment Rate (UNRATE).</p>
            
            <h3 style="margin-top: 30px;">Important Limitations and Disclaimer</h3>
            <p>This project is a data driven exploration. The findings here come entirely from the numbers reported in HMDA and FRED. We do not model or adjust for policy decisions, lender practices, or household wealth. HMDA data reflects only applications and originations.</p>
        </div>

    </div>
</div>

<script>
    // --- Global State ---
    const SD_FIPS = "06073"; // San Diego County
    const DEFAULT_FIPS = null; // Suffolk County, MA (Boston)
    let currentYear = 2021;
    let selectedCountyFips = null;
    let currentView = 'usa';
    let currentStateFips = null; 
    let tractDataByYear = new Map();
    let stateNameByFips = new Map();
    let countyNameByFips = new Map();
    let currentHeatmapMode = 'target'; 

    // State FIPS mapping
    const stateFipsToAbbr = {
        '01': 'AL', '02': 'AK', '04': 'AZ', '05': 'AR', '06': 'CA', '08': 'CO', '09': 'CT', '10': 'DE',
        '11': 'DC', '12': 'FL', '13': 'GA', '15': 'HI', '16': 'ID', '17': 'IL', '18': 'IN', '19': 'IA',
        '20': 'KS', '21': 'KY', '22': 'LA', '23': 'ME', '24': 'MD', '25': 'MA', '26': 'MI', '27': 'MN',
        '28': 'MS', '29': 'MO', '30': 'MT', '31': 'NE', '32': 'NV', '33': 'NH', '34': 'NJ', '35': 'NM',
        '36': 'NY', '37': 'NC', '38': 'ND', '39': 'OH', '40': 'OK', '41': 'OR', '42': 'PA', '44': 'RI',
        '45': 'SC', '46': 'SD', '47': 'TN', '48': 'TX', '49': 'UT', '50': 'VT', '51': 'VA', '53': 'WA',
        '54': 'WV', '55': 'WI', '56': 'WY'
    };
    const stateAbbrToFips = Object.fromEntries(Object.entries(stateFipsToAbbr).map(a => a.reverse()));

    // --- UI Logic: Slide Switching ---
    function switchSlide(sectionId, slideNum) {
        const section = document.getElementById(sectionId);
        // Toggle Slides
        section.querySelectorAll('.slide').forEach(el => el.classList.remove('active'));
        section.querySelector(`.slide-${slideNum}`).classList.add('active');
        
        // Toggle Buttons
        const btns = section.querySelectorAll('.nav-btn');
        btns.forEach(b => b.classList.remove('active'));
        btns[slideNum - 1].classList.add('active');
    }

    // --- Data Loading ---
    const filesToLoad = [
        d3.csv("location_data.csv"),
        d3.csv("hmda_tract_2018.csv"),
        d3.csv("hmda_tract_2019.csv"),
        d3.csv("hmda_tract_2020.csv"),
        d3.csv("hmda_tract_2021.csv"),
        d3.csv("hmda_tract_2022.csv"),
        d3.csv("hmda_tract_2023.csv")
    ];

    Promise.all(filesToLoad).then(([locationData, ...tractArrays]) => {
        processLocationData(locationData);
        
        const years = [2018, 2019, 2020, 2021, 2022, 2023];
        tractArrays.forEach((data, i) => {
            const year = years[i];
            const processed = data.map(d => {
                const geo = (year >= 2022) ? (d.geo2020 || '') : (d.geo2010 || '');
                return {
                    ...d,
                    county_fips: geo.substring(0, 5).padStart(5, '0'),
                    state_fips: geo.substring(0, 2).padStart(2, '0'),
                    year: year
                };
            }).filter(d => d.county_fips.length === 5);
            tractDataByYear.set(year, processed);
        });

        initControls(years);
        renderUSAMap(); 
        document.getElementById('loading').style.display = 'none';

        // --- LOAD DEFAULT: BOSTON (Suffolk, MA) ---
        setTimeout(() => {
            generateStory(DEFAULT_FIPS);
            document.getElementById('story-container').style.display = 'block';
        }, 500);

    }).catch(err => {
        console.error("Data Load Error:", err);
        document.getElementById('loading').innerHTML = `<p style="color:red">Error loading data: ${err.message}</p>`;
    });

    // --- Helper: Location Names ---
    function processLocationData(data) {
        data.forEach(d => {
            const stateFips = String(d.STATE).padStart(2, '0');
            if (d.SUMLEV === '040') stateNameByFips.set(stateFips, d.STNAME);
            if (d.SUMLEV === '050') {
                const fips = stateFips + String(d.COUNTY).padStart(3, '0');
                countyNameByFips.set(fips, d.CTYNAME);
            }
        });
        
        const select = document.getElementById('state-select');
        Array.from(stateNameByFips.entries())
            .sort((a,b) => a[1].localeCompare(b[1]))
            .forEach(([k,v]) => {
                const opt = document.createElement('option');
                opt.value = k;
                opt.text = v;
                select.appendChild(opt);
            });
    }

    function initControls(years) {
        const yearSelect = document.getElementById('year-select');
        years.forEach(y => {
            const opt = document.createElement('option');
            opt.value = y;
            opt.text = y;
            yearSelect.appendChild(opt);
        });
        yearSelect.value = currentYear;

        yearSelect.addEventListener('change', (e) => {
            currentYear = +e.target.value;
            if (currentView === 'usa') renderUSAMap();
            else if (currentView === 'state') renderCountyMap(currentStateFips);
            if (selectedCountyFips) generateStory(selectedCountyFips);
        });

        document.getElementById('state-select').addEventListener('change', (e) => {
            const stateFips = e.target.value;
            if (stateFips) enterStateView(stateFips);
            else resetToUSA();
        });
    }

    // --- Map Logic ---
    function renderUSAMap() {
        currentView = 'usa';
        currentStateFips = null;
        document.getElementById('back-btn').style.display = 'none';
        document.getElementById('map-status').textContent = `Viewing: United States (${currentYear})`;
        document.getElementById('map-instruction').textContent = "üëÜ Click on any State to drill down.";
        document.getElementById('state-select').value = "";

        const data = tractDataByYear.get(currentYear);
        if (!data) return;

        const stateAgg = d3.rollup(data, 
            v => {
                const total = d3.sum(v, d => +d.owner_purchase_originations || 0);
                const white = d3.sum(v, d => +d.race_white_purchase || 0);
                return total > 0 ? 1 - (white / total) : 0;
            },
            d => stateFipsToAbbr[d.state_fips] || "Unknown"
        );

        const locations = Array.from(stateAgg.keys()).filter(k => k !== "Unknown");
        const z = locations.map(k => stateAgg.get(k));

        const trace = {
            type: 'choropleth',
            locationmode: 'USA-states',
            locations: locations,
            z: z,
            colorscale: 'Blues',
            zmin: 0, zmax: 0.8,
            colorbar: { title: 'Minority Share', tickformat: '.0%' },
            marker: { line: { color: 'white', width: 1 } },
            hovertemplate: '<b>%{text}</b><br>Minority Share: %{z:.1%}<extra></extra>',
            text: locations.map(abbr => {
                const fips = stateAbbrToFips[abbr];
                return stateNameByFips.get(fips) || abbr;
            })
        };

        const layout = {
            geo: { scope: 'usa', projection: { type: 'albers usa' } },
            margin: { t: 0, b: 0, l: 0, r: 0 },
            height: 500
        };

        Plotly.newPlot('map-container', [trace], layout, {responsive: true}).then(gd => {
            gd.on('plotly_click', d => {
                const abbr = d.points[0].location;
                const fips = stateAbbrToFips[abbr];
                if(fips) enterStateView(fips);
            });
        });
    }

    function enterStateView(stateFips) {
        currentStateFips = stateFips;
        currentView = 'state';
        
        document.getElementById('state-select').value = stateFips;
        document.getElementById('back-btn').style.display = 'inline-block';
        const stateName = stateNameByFips.get(stateFips);
        document.getElementById('map-status').textContent = `Viewing: ${stateName} (${currentYear})`;
        document.getElementById('map-instruction').textContent = `üëÜ Click on any ${stateName} County to compare with San Diego.`;

        renderCountyMap(stateFips);
    }

    function renderCountyMap(stateFips) {
        const data = tractDataByYear.get(currentYear);
        if (!data) return;

        const stateData = data.filter(d => d.state_fips === stateFips);

        const countyAgg = d3.rollup(stateData, 
            v => {
                const total = d3.sum(v, d => +d.owner_purchase_originations || 0);
                const white = d3.sum(v, d => +d.race_white_purchase || 0);
                return total > 0 ? 1 - (white / total) : 0;
            },
            d => d.county_fips
        );

        const locations = Array.from(countyAgg.keys());
        const z = Array.from(countyAgg.values());

        const trace = {
            type: 'choropleth',
            locationmode: 'geojson-id',
            geojson: 'https://raw.githubusercontent.com/plotly/datasets/master/geojson-counties-fips.json',
            locations: locations,
            z: z,
            colorscale: 'Blues',
            zmin: 0, zmax: 1,
            colorbar: { title: 'Minority Share', tickformat: '.0%' },
            marker: { line: { color: 'white', width: 0.5 } },
            hovertemplate: '<b>%{text}</b><br>Minority Share: %{z:.1%}<extra></extra>',
            text: locations.map(f => countyNameByFips.get(f) || f)
        };

        const layout = {
            geo: {
                scope: 'usa',
                projection: { type: 'albers usa' },
                fitbounds: 'locations' 
            },
            margin: { t: 0, b: 0, l: 0, r: 0 },
            height: 500
        };

        Plotly.newPlot('map-container', [trace], layout, {responsive: true}).then(gd => {
            gd.on('plotly_click', d => {
                const fips = d.points[0].location;
                generateStory(fips);
                document.getElementById('story-container').style.display = 'block';
                document.getElementById('story-container').scrollIntoView({behavior: 'smooth'});
            });
        });
    }

    function resetToUSA() {
        renderUSAMap();
    }

    // --- STORY GENERATION & ANALYSIS ---
    function generateStory(targetFips) {
        selectedCountyFips = targetFips;
        const yearData = tractDataByYear.get(currentYear);
        
        const targetData = yearData.filter(d => d.county_fips === targetFips);
        const sdData = yearData.filter(d => d.county_fips === SD_FIPS);

        const targetName = countyNameByFips.get(targetFips) || "Your County";
        
        // Update Target Name Placeholders
        document.querySelectorAll('.county-name-target').forEach(el => el.textContent = targetName);

        // Stats
        const getMinorityShare = (data) => {
            const total = d3.sum(data, d => +d.owner_purchase_originations || 0);
            const white = d3.sum(data, d => +d.race_white_purchase || 0);
            return total > 0 ? ((1 - (white/total)) * 100).toFixed(1) + '%' : 'N/A';
        };
        document.getElementById('hero-target-stat').textContent = getMinorityShare(targetData);
        document.getElementById('hero-sd-stat').textContent = getMinorityShare(sdData);

        // Generate Analysis for each Section
        generateLoanAnalysis(targetData, targetName);
        generateAgeAnalysis(targetData, targetName);
        generateRaceAnalysis(targetData, targetName);
        generateIncomeAnalysis(targetData, targetName);

        // Render Charts
        renderLoanChart(targetData, sdData);
        renderAgeChart(targetData, sdData);
        renderRaceChart(targetData, sdData);
        renderIncomeChart(targetData, sdData);
        renderHeatmap(targetData);
        
        currentHeatmapMode = 'target';
        updateHeatmapButton();
        
        // Reset all sliders to view 1
        document.querySelectorAll('.slide-1').forEach(s => s.classList.add('active'));
        document.querySelectorAll('.slide-2').forEach(s => s.classList.remove('active'));
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.nav-controls button:first-child').forEach(b => b.classList.add('active'));
    }

    // --- Analysis Generators (Updated Logic) ---
    function generateLoanAnalysis(data, name) {
        // Bin Data
        let bins = [0,0,0,0];
        data.forEach(d => {
            const amt = +d.owner_loan_amount_median || 0;
            const count = +d.owner_purchase_originations || 0;
            if (amt < 200000) bins[0] += count;
            else if (amt < 400000) bins[1] += count;
            else if (amt < 600000) bins[2] += count;
            else bins[3] += count;
        });
        const total = d3.sum(bins);
        if (total === 0) return;
        
        const labels = ['$0-200k', '$200k-400k', '$400k-600k', '$600k+'];
        const maxIdx = bins.indexOf(Math.max(...bins));
        const maxPct = (bins[maxIdx] / total * 100).toFixed(1);
        const dominantBin = labels[maxIdx];

        let headline, narrative;

        if (maxIdx >= 3) {
            headline = "Market Exclusion through Pricing";
            narrative = `The dominant price range in ${name} is <strong>${dominantBin}</strong>, accounting for <strong>${maxPct}%</strong> of all loans. 
            This high-cost environment signals deep wealth segregation, where homeownership is accessible primarily to the affluent, potentially displacing long-time residents and limiting economic mobility for working families.`;
        } else if (maxIdx <= 1) {
            headline = "Entry-Level Access or Undervaluation?";
            narrative = `With <strong>${maxPct}%</strong> of loans falling in the <strong>${dominantBin}</strong> range, ${name} remains one of the few areas offering access to first-time buyers. 
            However, this affordability may come with challenges: are these homes appreciating in value, or does this reflect historical underinvestment in local housing stock?`;
        } else {
            headline = "The Missing Middle?";
            narrative = `The market is concentrated in the <strong>${dominantBin}</strong> range (${maxPct}%), suggesting a stable middle-class housing stock. 
            Yet, as prices creep upward, the question remains: is this middle tier shrinking, forcing moderate-income buyers out of the market?`;
        }

        document.getElementById('analysis-loan-highlight').textContent = headline;
        document.getElementById('analysis-loan-text').innerHTML = narrative;
    }

    function generateAgeAnalysis(data, name) {
        const counts = {
            'Young Adults (18-34)': d3.sum(data, d => +(d.age_younger_purchase||0)),
            'Mid-Career (35-54)': d3.sum(data, d => +(d.age_middleyounger_purchase||0)) + d3.sum(data, d => +(d.age_middleolder_purchase||0)),
            'Older (55+)': d3.sum(data, d => +(d.age_older_purchase||0))
        };
        const total = d3.sum(Object.values(counts));
        if (total === 0) return;

        const maxGroup = Object.keys(counts).reduce((a, b) => counts[a] > counts[b] ? a : b);
        const maxPct = (counts[maxGroup] / total * 100).toFixed(1);

        let headline, narrative;

        if (maxGroup.includes('Young')) {
            headline = "Building Future Wealth";
            narrative = `Young adults (18-34) dominate the market with <strong>${maxPct}%</strong> of loans. 
            This suggests ${name} is acting as a critical launchpad for generational wealth building. The key challenge for inequality here is ensuring this access is shared equitably across racial lines, rather than just benefiting those with familial down payment assistance.`;
        } else if (maxGroup.includes('Older')) {
            headline = "Wealth Consolidation";
            narrative = `Older borrowers (55+) account for <strong>${maxPct}%</strong> of mortgage activity. 
            A market skewed toward older buyers often signals high entry barriers, where purchases are driven by accumulated equity from previous homes rather than income‚Äîeffectively locking out younger, first-time buyers without intergenerational wealth.`;
        } else {
            headline = "Established Homeowners";
            narrative = `The market is anchored by mid-career borrowers (${maxGroup}), who represent <strong>${maxPct}%</strong> of activity. 
            This typically reflects a trade-up market where existing homeowners leverage equity to move, potentially widening the gap between those who already own and those trying to enter.`;
        }

        document.getElementById('analysis-age-highlight').textContent = headline;
        document.getElementById('analysis-age-text').innerHTML = narrative;
    }

    function generateRaceAnalysis(data, name) {
        const counts = {
            'White': d3.sum(data, d => +(d.race_white_purchase||0)),
            'African American': d3.sum(data, d => +(d.race_black_purchase||0)),
            'Hispanic': d3.sum(data, d => +(d.race_hispanic_purchase||0)),
            'Asian': d3.sum(data, d => +(d.race_asian_purchase||0)),
            'Total': d3.sum(data, d => +(d.owner_purchase_originations||0))
        };
        
        if (counts.Total === 0) return;

        const minPct = ((counts.Total - counts.White) / counts.Total * 100).toFixed(1);
        const whitePct = (counts.White / counts.Total * 100).toFixed(1);
        const blackPct = (counts['African American'] / counts.Total * 100).toFixed(1);

        let headline, narrative;

        if (parseFloat(minPct) < 20) {
            headline = "Systemic Exclusion";
            narrative = `In ${name}, minority borrowers represent only <strong>${minPct}%</strong> of the market, compared to <strong>${whitePct}%</strong> for White borrowers. 
            This stark disparity highlights persistent systemic barriers‚Äîwhether through pricing, credit scoring, or inventory shortages‚Äîthat continue to exclude communities of color from the wealth-building power of homeownership.`;
        } else if (parseFloat(minPct) > 50) {
            headline = "A Shift in Demographics";
            narrative = `Minority borrowers make up the majority (<strong>${minPct}%</strong>) of the lending market in ${name}. 
            While this indicates high access, it is crucial to examine the *quality* of this access: are these borrowers receiving fair interest rates and accessing appreciating neighborhoods, or are they concentrated in areas with lower equity returns?`;
        } else {
            headline = "Diversity with Disparities";
            narrative = `While ${name} shows a diverse borrower base (${minPct}% minority), African American borrowers specifically account for <strong>${blackPct}%</strong>. 
            This gap between overall diversity and Black homeownership suggests that specific barriers‚Äîlikely rooted in historical redlining and wealth gaps‚Äîremain stubbornly effective.`;
        }

        document.getElementById('analysis-race-highlight').textContent = headline;
        document.getElementById('analysis-race-text').innerHTML = narrative;
    }

    function generateIncomeAnalysis(data, name) {
        const map = {
            'Very Low': d3.sum(data, d => +(d.income_verylow_purchase||0)),
            'Low': d3.sum(data, d => +(d.income_low_purchase||0)),
            'Moderate': d3.sum(data, d => +(d.income_moderate_purchase||0)),
            'High': d3.sum(data, d => +(d.income_high_purchase||0))
        };
        const total = d3.sum(Object.values(map));
        if (total === 0) return;

        const maxGroup = Object.keys(map).reduce((a, b) => map[a] > map[b] ? a : b);
        const maxPct = (map[maxGroup] / total * 100).toFixed(1);

        let headline, narrative;

        if (maxGroup === 'High') {
            headline = "The Wealth Gatekeeper";
            narrative = `<strong>High Income</strong> borrowers secure <strong>${maxPct}%</strong> of all loans in ${name}. 
            This concentration of credit among the wealthy signals a market that has become structurally unaffordable for the working class, turning homeownership from a path to stability into a luxury good.`;
        } else if (maxGroup === 'Very Low' || maxGroup === 'Low') {
            headline = "Pathways for Modest Incomes";
            narrative = `Unlike many regions, ${name} sees <strong>${maxPct}%</strong> of loans going to <strong>${maxGroup} Income</strong> borrowers. 
            This suggests active affordable lending programs or lower housing costs. The critical question is whether these homes provide the same long-term wealth appreciation as those in higher-income brackets.`;
        } else {
            headline = "The Middle-Class Squeeze";
            narrative = `Activity is centered on <strong>${maxGroup} Income</strong> borrowers (${maxPct}%), indicating a stable middle-class market. 
            However, with high-income activity likely growing, these middle-income families may face increasing pressure, forcing them to stretch budgets significantly to compete.`;
        }

        document.getElementById('analysis-income-highlight').textContent = headline;
        document.getElementById('analysis-income-text').innerHTML = narrative;
    }

    // --- Charting Functions ---
    function getAggregatedStats(data, fieldMap) {
        const total = d3.sum(data, d => +d.owner_purchase_originations || 0);
        const stats = {};
        for (const [key, col] of Object.entries(fieldMap)) {
            const val = d3.sum(data, d => +d[col] || 0);
            stats[key] = total > 0 ? (val / total * 100) : 0;
        }
        return stats;
    }

    function renderLoanChart(target, sd) {
        const binData = (data) => {
            const counts = [0, 0, 0, 0];
            data.forEach(d => {
                const amt = +d.owner_loan_amount_median || 0;
                const count = +d.owner_purchase_originations || 0;
                if (amt < 200000) counts[0] += count;
                else if (amt < 400000) counts[1] += count;
                else if (amt < 600000) counts[2] += count;
                else counts[3] += count;
            });
            const total = d3.sum(counts);
            return counts.map(c => total > 0 ? (c / total * 100) : 0);
        };
        const targetVals = binData(target);
        const sdVals = binData(sd);
        const labels = ['$0-200k', '$200k-400k', '$400k-600k', '$600k+'];
        drawComparisonBar('chart-loan', labels, targetVals, sdVals, 'Percentage of Loans');
    }

    function renderAgeChart(target, sd) {
        const map = {
            '18-34': 'age_younger_purchase',
            '35-44': 'age_middleyounger_purchase',
            '45-54': 'age_middleolder_purchase',
            '55+': 'age_older_purchase'
        };
        const t = getAggregatedStats(target, map);
        const s = getAggregatedStats(sd, map);
        drawComparisonBar('chart-age', Object.keys(map), Object.values(t), Object.values(s), 'Share of Borrowers');
    }

    function renderRaceChart(target, sd) {
        const map = {
            'White': 'race_white_purchase',
            'African American': 'race_black_purchase',
            'Hispanic': 'race_hispanic_purchase',
            'Asian': 'race_asian_purchase'
        };
        const t = getAggregatedStats(target, map);
        const s = getAggregatedStats(sd, map);
        drawComparisonBar('chart-race', Object.keys(map), Object.values(t), Object.values(s), 'Share of Borrowers');
    }

    function renderIncomeChart(target, sd) {
        const map = {
            'Very Low': 'income_verylow_purchase',
            'Low': 'income_low_purchase',
            'Moderate': 'income_moderate_purchase',
            'High': 'income_high_purchase'
        };
        const t = getAggregatedStats(target, map);
        const s = getAggregatedStats(sd, map);
        drawComparisonBar('chart-income', Object.keys(map), Object.values(t), Object.values(s), 'Share of Borrowers');
    }

    function drawComparisonBar(divId, xLabels, targetY, sdY, yTitle) {
        const trace1 = {
            x: xLabels, y: targetY, name: 'Selected County', type: 'bar',
            marker: { color: '#54a0ff' }
        };
        const trace2 = {
            x: xLabels, y: sdY, name: 'San Diego', type: 'bar',
            marker: { color: '#ff9f43' }
        };
        const layout = {
            barmode: 'group',
            margin: { t: 20, b: 40, l: 40, r: 10 },
            showlegend: false,
            yaxis: { title: yTitle, ticksuffix: '%' },
            height: 350
        };
        Plotly.newPlot(divId, [trace1, trace2], layout, { responsive: true, displayModeBar: false });
    }

    // --- Heatmap Logic ---
    function toggleHeatmap() {
        currentHeatmapMode = currentHeatmapMode === 'target' ? 'sd' : 'target';
        updateHeatmapButton();
        const yearData = tractDataByYear.get(currentYear);
        const fips = currentHeatmapMode === 'target' ? selectedCountyFips : SD_FIPS;
        const data = yearData.filter(d => d.county_fips === fips);
        renderHeatmap(data);
    }

    function updateHeatmapButton() {
        const statusSpan = document.getElementById('heatmap-status').querySelector('span');
        const targetName = countyNameByFips.get(selectedCountyFips);
        if (currentHeatmapMode === 'target') {
            statusSpan.textContent = targetName;
            statusSpan.style.color = 'var(--target-color)';
        } else {
            statusSpan.textContent = "San Diego County";
            statusSpan.style.color = 'var(--sd-color)';
        }
    }

    function renderHeatmap(data) {
        const races = ['White', 'African American', 'Hispanic', 'Asian'];
        const raceKeys = ['white', 'black', 'hispanic', 'asian'];
        const incomes = ['Very Low', 'Low', 'Moderate', 'High'];
        
        const zCounts = races.map((_, i) => {
            const raceKey = raceKeys[i];
            return incomes.map(income => {
                const col = `race_${raceKey}_income_${income.toLowerCase().replace(' ', '')}`;
                return d3.sum(data, d => +d[col] || 0);
            });
        });

        const total = d3.sum(zCounts.flat());
        const zNorm = zCounts.map(row => row.map(val => total > 0 ? (val / total * 100) : 0));
        const textValues = zNorm.map(row => row.map(val => val.toFixed(1) + '%'));

        const trace = {
            z: zNorm,
            x: incomes,
            y: races,
            type: 'heatmap',
            colorscale: 'Blues',
            xgap: 5, ygap: 5,
            text: textValues, 
            texttemplate: '<b>%{text}</b>',
            textfont: { family: 'Arial, sans-serif', size: 16, color: 'auto' },
            hovertemplate: 'Income: %{x}<br>Race: %{y}<br>Share: %{z:.1f}%<extra></extra>'
        };

        const layout = {
            margin: { t: 20, b: 40, l: 140, r: 20 },
            height: 400,
            xaxis: { title: 'Income Level' },
            yaxis: { title: 'Race' }
        };

        Plotly.newPlot('chart-heatmap', [trace], layout, { responsive: true, displayModeBar: false });
    }

</script>

</body>
</html>